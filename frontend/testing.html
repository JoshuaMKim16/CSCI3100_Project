<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./Components/login/Login.css">
  <title>Test Comment Functionality</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
    }
    h1, h2 {
      color: #333;
    }
    .comment {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }
    .nested {
      margin-left: 20px;
      background-color: #f9f9f9;
    }
    button {
      margin-right: 5px;
    }
    label {
      display: block;
      margin-bottom: 4px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>Comment Functionality Test</h1>

  <!-- Section: Load comments -->
  <section id="load-comments">
    <h2>Load Comments</h2>
    <label for="locationId">Location ID:</label>
    <input type="text" id="locationId" placeholder="Enter location ID" />
    <button id="loadCommentsBtn">Load Comments</button>
  </section>

  <!-- Section: Display comments -->
  <section id="comments-section">
    <h2>Comments</h2>
    <div id="comments"></div>
  </section>

  <!-- Section: New comment form -->
  <section id="new-comment">
    <h2>Add New Comment</h2>
    <!-- Update the hidden author field with a valid user id from your database -->
    <form id="commentForm">
      <input type="hidden" id="author" value="67f92ce7b2ebd14f9a5417aa">
      <input type="hidden" id="location" value="">
      <!-- Optional: parent comment id for nested comments -->
      <input type="hidden" id="parentComment" value="">
      <label for="content">Comment Content:</label>
      <textarea id="content" rows="4" placeholder="Your comment here..."></textarea>
      <button type="submit">Submit Comment</button>
    </form>
  </section>

  <script>
    function createCommentElement(comment) {
      const div = document.createElement('div');
      div.className = 'comment';
      // Add an extra class if it's a nested comment
      if (comment.parentComment) {
        div.classList.add('nested');
      }
      // Use author name if populated, otherwise display author id.
      const authorName = comment.author && comment.author.name ? comment.author.name : comment.author;
      
      div.innerHTML = `
        <p>${comment.content}</p>
        <p><strong>Author:</strong> ${authorName}</p>
        <p><strong>Likes:</strong> ${comment.likes || 0} | <strong>Dislikes:</strong> ${comment.dislikes || 0}</p>
        <button onclick="likeComment('${comment._id}')">Like</button>
        <button onclick="dislikeComment('${comment._id}')">Dislike</button>
        <button onclick="deleteComment('${comment._id}')">Delete</button>
      `;
      return div;
    }

    /**
     * Function to fetch and display comments for a given location.
     */
    async function loadComments() {
      // Get location id from input
      const locationId = document.getElementById('locationId').value.trim();
      if (!locationId) {
        alert('Please enter a valid Location ID.');
        return;
      }

      // Set the location value for the new comment form
      document.getElementById('location').value = locationId;

      try {
        const response = await fetch(`http://localhost:3000/api/comments/location/${locationId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch comments.');
        }
        const comments = await response.json();
        const commentsDiv = document.getElementById('comments');
        commentsDiv.innerHTML = ''; // Clear existing comments

        if (comments.length === 0) {
          commentsDiv.innerHTML = '<p>No comments found for this location.</p>';
        } else {
          comments.forEach(comment => {
            const commentEl = createCommentElement(comment);
            commentsDiv.appendChild(commentEl);
          });
        }
      } catch (error) {
        console.error(error);
        alert('Error fetching comments: ' + error.message);
      }
    }

    /**
     * Event listener for loading comments when button is clicked.
     */
    document.getElementById('loadCommentsBtn').addEventListener('click', loadComments);

    /**
     * Event listener to handle new comment submission.
     */
    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = document.getElementById('content').value.trim();
      const author = document.getElementById('author').value;
      const location = document.getElementById('location').value;
      const parentComment = document.getElementById('parentComment').value || null;
      
      if (!content) {
        alert('Please enter a comment.');
        return;
      }
      
      console.log(content, author, location, parentComment)

      try {
        const response = await fetch('http://localhost:3000/api/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, author, location, parentComment })
        });
        
        
        if (!response.ok) {
          throw new Error('Could not submit comment.');
        }
        
        const newComment = await response.json();
        alert('Comment added successfully!');
        // Clear the comment textarea for a new entry
        document.getElementById('content').value = '';
        
        // Refresh the comment list
        loadComments();
      } catch (error) {
        console.error(error);
        alert('Error adding comment: ' + error.message);
      }
    });

    /**
     * Function to like a comment by its id.
     * @param {string} commentId - The id of the comment to like.
     */
    async function likeComment(commentId) {
      try {
        const response = await fetch(`http://localhost:3000/api/comments/${commentId}/like`, {
          method: 'POST'
        });
        if (!response.ok) {
          throw new Error('Failed to like comment.');
        }
        // Reload comments after action
        loadComments();
      } catch (error) {
        console.error(error);
        alert('Error liking comment: ' + error.message);
      }
    }

    /**
     * Function to dislike a comment by its id.
     * @param {string} commentId - The id of the comment to dislike.
     */
    async function dislikeComment(commentId) {
      try {
        const response = await fetch(`http://localhost:3000/api/comments/${commentId}/dislike`, {
          method: 'POST'
        });
        if (!response.ok) {
          throw new Error('Failed to dislike comment.');
        }
        // Reload comments after action
        loadComments();
      } catch (error) {
        console.error(error);
        alert('Error disliking comment: ' + error.message);
      }
    }

    /**
     * Function to delete a comment by its id.
     * @param {string} commentId - The id of the comment to delete.
     */
    async function deleteComment(commentId) {
      if (!confirm('Are you sure you want to delete this comment?')) {
        return;
      }
      try {
        const response = await fetch(`http://localhost:3000/api/comments/${commentId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          throw new Error('Failed to delete comment.');
        }
        // Reload comments after deletion
        loadComments();
      } catch (error) {
        console.error(error);
        alert('Error deleting comment: ' + error.message);
      }
    }
  </script>
</body>
</html>